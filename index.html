<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cerpen Manager ‚Äî Fixed Version</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.2.0/docx.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<style>
  :root{
    --bg: #0f1724;
    --card: #1e293b;
    --border: rgba(255,255,255,0.08);
    --primary: #3b82f6;
    --accent: #8b5cf6;
    --text: #e2e8f0;
    --muted: #94a3b8;
    --folder: #fbbf24;
    --danger: #ef4444;
    --success: #10b981;
  }
  *{box-sizing:border-box}
  body{
    margin:0;font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);
    min-height:100vh;display:flex;flex-direction:column;
  }
  
  /* Layout */
  .container{
    max-width:1200px;width:94%;margin:0 auto;padding:20px 0 60px;
    display:grid;grid-template-columns: 1fr 450px;gap:24px;
  }
  @media(max-width:900px){ .container{grid-template-columns:1fr} }

  /* Header */
  header{
    padding:20px 0;border-bottom:1px solid var(--border);margin-bottom:20px;
    background:rgba(15,23,36,0.9);backdrop-filter:blur(10px);position:sticky;top:0;z-index:10;
  }
  .head-wrap{max-width:1200px;width:94%;margin:0 auto;display:flex;justify-content:space-between;align-items:center}
  .brand{font-weight:700;font-size:1.2rem;background:linear-gradient(to right, var(--primary), var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}

  /* Cards */
  .card{
    background:var(--card);border:1px solid var(--border);border-radius:12px;padding:24px;
    box-shadow:0 10px 15px -3px rgba(0,0,0,0.3);position:relative;
  }
  h2,h3{margin:0 0 16px 0;font-weight:600}
  
  /* Inputs */
  label{display:block;color:var(--muted);font-size:0.85rem;margin-bottom:6px;margin-top:14px}
  input, select, textarea{
    width:100%;background:#0f1724;border:1px solid var(--border);color:white;
    padding:12px;border-radius:8px;font-family:inherit;outline:none;transition:0.2s;
  }
  input:focus, textarea:focus{border-color:var(--primary)}
  textarea{min-height:200px;line-height:1.6;resize:vertical}

  /* Buttons */
  .btn{
    cursor:pointer;background:var(--primary);color:white;border:none;padding:10px 16px;
    border-radius:8px;font-weight:600;font-size:0.9rem;display:inline-flex;align-items:center;gap:8px;
    transition:0.2s;
  }
  .btn:hover{filter:brightness(1.1)}
  .btn:disabled{opacity:0.6;cursor:not-allowed}
  .btn.secondary{background:transparent;border:1px solid var(--border);color:var(--muted)}
  .btn.secondary:hover{border-color:var(--text);color:var(--text)}
  .btn.danger{background:var(--danger);color:white}
  .btn.download{background:var(--success);}

  /* Admin Folder Grid */
  .folder-grid{
    display:grid;grid-template-columns:repeat(auto-fill, minmax(100px, 1fr));gap:16px;margin-top:16px;
  }
  .folder-item{
    background:rgba(255,255,255,0.03);border:1px solid var(--border);border-radius:10px;
    padding:16px;text-align:center;cursor:pointer;transition:0.2s;
    display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;
  }
  .folder-item:hover{background:rgba(255,255,255,0.06);transform:translateY(-2px);border-color:var(--folder)}
  .folder-icon{width:40px;height:40px;fill:var(--folder)}
  .folder-name{font-size:0.8rem;color:var(--muted);word-break:break-word;line-height:1.2}

  /* File List inside Folder */
  .file-list{display:flex;flex-direction:column;gap:12px;margin-top:16px}
  .file-card{
    background:rgba(0,0,0,0.2);border:1px solid var(--border);padding:14px;border-radius:8px;
  }
  .file-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px}
  .file-title{font-weight:600;color:var(--text);font-size:0.95rem}
  .file-meta{font-size:0.75rem;color:var(--muted);margin-bottom:10px;font-family:'JetBrains Mono', monospace}
  .file-actions{display:flex;gap:8px;margin-top:12px;border-top:1px solid var(--border);padding-top:10px;flex-wrap:wrap}
  .file-actions button{font-size:0.75rem;padding:6px 12px}

  /* Editor Overlay */
  #editorOverlay{
    position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);z-index:100;
    display:none;align-items:center;justify-content:center;backdrop-filter:blur(5px);
  }
  .editor-modal{
    width:90%;max-width:700px;background:var(--card);border:1px solid var(--border);
    border-radius:12px;padding:24px;box-shadow:0 20px 50px rgba(0,0,0,0.5);
    display:flex;flex-direction:column;max-height:90vh;
  }
  .editor-body{overflow-y:auto;padding-right:8px;flex:1}

  .status-msg{margin-top:10px;font-size:0.85rem;min-height:20px;font-weight:500}
  .success{color:var(--success)} .error{color:var(--danger)}
</style>
</head>
<body>

<header>
  <div class="head-wrap">
    <div class="brand">üöÄ Cerpen Manager</div>
    <div style="font-size:0.85rem;color:var(--muted)">System v2.1 ‚Ä¢ Fixed & Fast</div>
  </div>
</header>

<div class="container">
  
  <section>
    <div class="card">
      <h2>Tulis & Upload Cerpen</h2>
      <p style="color:var(--muted);font-size:0.9rem;margin-bottom:20px">
        Isi data di bawah ini, lalu tekan Upload agar Admin bisa memeriksanya.
      </p>

      <label>Judul Cerpen</label>
      <input type="text" id="client-judul" placeholder="Contoh: Petualangan di Kantor">

      <label>Pilih Divisi (Tujuan Folder)</label>
      <select id="client-divisi">
        <option value="CERPEN_DIMAS">üìÇ Divisi DIMAS</option>
        <option value="CERPEN_MEDYO">üìÇ Divisi MEDYO</option>
        <option value="CERPEN_NAI">üìÇ Divisi NAI</option>
        <option value="CERPEN_RAZAN">üìÇ Divisi RAZAN</option>
        <option value="CERPEN_REZA">üìÇ Divisi REZA</option>
        <option value="CERPEN_SYAHDAN">üìÇ Divisi SYAHDAN</option>
        <option value="CERPEN_ABDI">üìÇ Divisi ABDI</option>
      </select>

      <label>Isi Cerpen</label>
      <textarea id="client-isi" placeholder="Mulai mengetik cerpenmu di sini..."></textarea>

      <div style="margin-top:20px;display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn" onclick="clientUpload()">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
          Upload ke Admin
        </button>
        <button class="btn secondary" onclick="clientDownloadOnly()">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
          Download Pribadi (.docx)
        </button>
      </div>
      <div id="client-status" class="status-msg"></div>
    </div>
  </section>

  <aside>
    <div class="card" id="login-card">
      <h3>üîê Admin Login</h3>
      <p style="font-size:0.85rem;color:var(--muted)">Masuk untuk mengelola file dalam folder.</p>
      
      <label>Email Admin</label>
      <input type="email" id="admin-email" placeholder="admin@domain.com">
      
      <label>Password</label>
      <input type="password" id="admin-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      
      <button class="btn" id="btnLogin" style="width:100%;margin-top:20px" onclick="login()">Masuk</button>
      <div id="login-status" class="status-msg"></div>
    </div>

    <div class="card" id="admin-dashboard" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
        <h3 style="margin:0">üóÇÔ∏è File Manager</h3>
        <button class="btn secondary" style="font-size:0.75rem;padding:4px 8px" onclick="logout()">Logout</button>
      </div>

      <div id="view-folders">
        <div class="folder-grid" id="folder-container"></div>
      </div>

      <div id="view-files" style="display:none">
        <button class="btn secondary" onclick="backToFolders()" style="margin-bottom:12px;width:100%">
          ‚¨Ö Kembali ke Daftar Folder
        </button>
        <div style="background:rgba(255,255,255,0.05);padding:10px;border-radius:6px;margin-bottom:10px;border:1px solid var(--folder)">
          <strong id="current-folder-name" style="color:var(--folder)">Folder: -</strong>
        </div>
        <div id="file-list-container" class="file-list">
          <div style="text-align:center;color:var(--muted);padding:20px">Memuat file...</div>
        </div>
      </div>

    </div>
  </aside>

</div>

<div id="editorOverlay">
  <div class="editor-modal">
    <div class="editor-body">
      <h3 style="margin-top:0">‚úèÔ∏è Edit File Client</h3>
      <input type="hidden" id="edit-docId">
      <input type="hidden" id="edit-divisi">
      
      <label>Judul</label>
      <input type="text" id="edit-judul">
      
      <label>Isi Konten</label>
      <textarea id="edit-isi" style="height:350px"></textarea>
    </div>
    
    <div style="display:flex;gap:10px;margin-top:20px;justify-content:flex-end;border-top:1px solid var(--border);padding-top:15px">
      <button class="btn secondary" onclick="closeEditor()">Batal</button>
      <button class="btn" onclick="saveEditor()">Simpan Perubahan</button>
    </div>
  </div>
</div>

<footer style="text-align:center;padding:20px;color:var(--muted);font-size:0.8rem">
  @RzaHex ‚Äî Admin System v2.1 (Fixed)
</footer>

<script>
/* =========================================
   1. KONFIGURASI FIREBASE
   ‚ö† PENTING: GANTI DENGAN CONFIG KAMU ‚ö†
   ========================================= */
const firebaseConfig = {
  apiKey: "AIzaSyC2Lo4wJcazvGvrrPvrMdx_VwFnn1R9TDw", 
  authDomain: "rzacorp-59dd8.firebaseapp.com",
  projectId: "rzacorp-59dd8",
  storageBucket: "rzacorp-59dd8.appspot.com",
  messagingSenderId: "416858419245",
  appId: "1:416858419245:android:5d146b8fa173e7c81548a4"
};

// Inisialisasi Firebase (Versi Compat)
if (!firebase.apps.length) {
  firebase.initializeApp(firebaseConfig);
}
const auth = firebase.auth();
const db = firebase.firestore();

/* =========================================
   2. DATA DIVISI
   ========================================= */
const DIVISIONS = [
  "CERPEN_DIMAS", "CERPEN_MEDYO", "CERPEN_NAI", 
  "CERPEN_RAZAN", "CERPEN_REZA", "CERPEN_SYAHDAN", "CERPEN_ABDI"
];

/* =========================================
   3. SYSTEM ADMIN (LOGIN & FOLDERS)
   ========================================= */

// Cek Status Login (Otomatis)
auth.onAuthStateChanged((user) => {
  const loginCard = document.getElementById('login-card');
  const dashCard = document.getElementById('admin-dashboard');
  
  if (user) {
    // Jika User Login
    console.log("Logged in as:", user.email);
    loginCard.style.display = 'none';
    dashCard.style.display = 'block';
    renderFolders();
  } else {
    // Jika User Logout/Belum Login
    console.log("No user.");
    loginCard.style.display = 'block';
    dashCard.style.display = 'none';
  }
});

// Fungsi Login
function login() {
  const e = document.getElementById('admin-email').value;
  const p = document.getElementById('admin-pass').value;
  const s = document.getElementById('login-status');
  const btn = document.getElementById('btnLogin');

  if(!e || !p) {
    s.innerHTML = '<span class="error">Email dan Password wajib diisi!</span>';
    return;
  }

  s.innerHTML = 'Sedang masuk...';
  s.className = 'status-msg'; // reset warna
  btn.disabled = true;

  auth.signInWithEmailAndPassword(e, p)
    .then((uc) => {
      s.innerHTML = '<span class="success">Berhasil! Memuat data...</span>';
      // UI akan berpindah otomatis karena onAuthStateChanged
    })
    .catch((error) => {
      console.error(error);
      btn.disabled = false;
      let msg = "Terjadi kesalahan.";
      if(error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password') msg = "Password atau Email salah.";
      else if(error.code === 'auth/user-not-found') msg = "Email tidak terdaftar.";
      else if(error.code === 'auth/too-many-requests') msg = "Terlalu banyak mencoba. Tunggu sebentar.";
      else if(error.code === 'auth/network-request-failed') msg = "Koneksi internet bermasalah.";
      
      s.innerHTML = `<span class="error">${msg}</span>`;
    });
}

// Fungsi Logout
function logout() {
  if(confirm("Yakin ingin logout?")) {
    auth.signOut();
    document.getElementById('login-status').innerHTML = '';
    backToFolders();
  }
}

// Render Folder
function renderFolders() {
  const container = document.getElementById('folder-container');
  container.innerHTML = '';
  DIVISIONS.forEach(divName => {
    const div = document.createElement('div');
    div.className = 'folder-item';
    div.onclick = () => openFolder(divName);
    div.innerHTML = `
      <svg class="folder-icon" viewBox="0 0 24 24"><path d="M20 6h-8l-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2z"/></svg>
      <div class="folder-name">${divName.replace('CERPEN_', '')}</div>
    `;
    container.appendChild(div);
  });
}

// Buka Folder & Load Data
function openFolder(divName) {
  document.getElementById('view-folders').style.display = 'none';
  document.getElementById('view-files').style.display = 'block';
  document.getElementById('current-folder-name').innerText = `Folder: ${divName.replace('CERPEN_','')}`;
  
  const list = document.getElementById('file-list-container');
  list.innerHTML = '<div style="text-align:center;padding:20px;color:var(--muted)">Mengambil data...</div>';

  db.collection(divName).orderBy('createdAt', 'desc').get()
    .then(snap => {
      list.innerHTML = '';
      if(snap.empty) {
        list.innerHTML = '<div style="text-align:center;padding:20px;color:var(--muted)">Folder kosong.</div>';
        return;
      }
      snap.forEach(doc => {
        list.appendChild(createFileCard(doc.id, doc.data(), divName));
      });
    })
    .catch(err => {
      console.error(err);
      list.innerHTML = '<div class="error" style="text-align:center">Gagal memuat data. Cek koneksi.</div>';
    });
}

function backToFolders() {
  document.getElementById('view-files').style.display = 'none';
  document.getElementById('view-folders').style.display = 'block';
}

function createFileCard(id, data, div) {
  const el = document.createElement('div');
  el.className = 'file-card';
  const time = data.createdAt ? new Date(data.createdAt.seconds*1000).toLocaleString() : '-';
  const safeJudul = escapeHtml(data.judul || '(Tanpa Judul)');
  
  el.innerHTML = `
    <div class="file-header">
      <div class="file-title">üìÑ ${safeJudul}</div>
    </div>
    <div class="file-meta">Uploaded: ${time}</div>
    <div style="font-size:0.85rem;color:#cbd5e1;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;margin-bottom:8px">
       ${escapeHtml(data.isi)}
    </div>
    <div class="file-actions">
      <button class="btn secondary" onclick="editFile('${div}','${id}')">‚úèÔ∏è Edit</button>
      <button class="btn danger" onclick="delFile('${div}','${id}')">üóëÔ∏è Hapus</button>
      <button class="btn download" onclick="dlFile('${div}','${id}')">‚¨áÔ∏è Install .docx</button>
    </div>
  `;
  return el;
}

/* =========================================
   4. FITUR CLIENT
   ========================================= */
function clientUpload() {
  const judul = document.getElementById('client-judul').value.trim();
  const isi = document.getElementById('client-isi').value.trim();
  const div = document.getElementById('client-divisi').value;
  const stat = document.getElementById('client-status');

  if(!judul || !isi) {
    stat.innerHTML = '<span class="error">Judul & Isi harus diisi!</span>';
    return;
  }
  stat.innerHTML = 'Mengirim...';

  db.collection(div).add({
    judul: judul, isi: isi,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  }).then(() => {
    stat.innerHTML = '<span class="success">‚úÖ Terkirim ke Admin Folder '+div+'!</span>';
    document.getElementById('client-judul').value='';
    document.getElementById('client-isi').value='';
  }).catch(err => {
    stat.innerHTML = '<span class="error">Gagal kirim: '+err.message+'</span>';
  });
}

function clientDownloadOnly(){
  const j = document.getElementById('client-judul').value || "Tanpa Judul";
  const i = document.getElementById('client-isi').value;
  if(!i) return alert("Isi kosong!");
  generateDocx(j, i, `DRAFT_${j}.docx`);
}

/* =========================================
   5. ACTIONS (EDIT, DELETE, DOWNLOAD)
   ========================================= */
// EDIT
function editFile(div, id) {
  db.collection(div).doc(id).get().then(doc => {
    if(doc.exists) {
      const d = doc.data();
      document.getElementById('edit-docId').value = id;
      document.getElementById('edit-divisi').value = div;
      document.getElementById('edit-judul').value = d.judul;
      document.getElementById('edit-isi').value = d.isi;
      document.getElementById('editorOverlay').style.display = 'flex';
    }
  });
}
function closeEditor(){ document.getElementById('editorOverlay').style.display = 'none'; }
function saveEditor(){
  const id = document.getElementById('edit-docId').value;
  const div = document.getElementById('edit-divisi').value;
  const j = document.getElementById('edit-judul').value;
  const i = document.getElementById('edit-isi').value;

  db.collection(div).doc(id).update({ judul: j, isi: i }).then(() => {
    alert("Berhasil diupdate!");
    closeEditor();
    openFolder(div);
  });
}

// DELETE
function delFile(div, id) {
  if(confirm("Hapus file ini permanen?")) {
    db.collection(div).doc(id).delete().then(() => openFolder(div));
  }
}

// DOWNLOAD
function dlFile(div, id) {
  db.collection(div).doc(id).get().then(doc => {
    if(doc.exists) {
      const d = doc.data();
      generateDocx(d.judul, d.isi, `${div}_${d.judul.replace(/\s+/g,'_')}.docx`);
    }
  });
}

/* =========================================
   6. UTILITIES
   ========================================= */
function generateDocx(title, content, filename){
  const { Document, Packer, Paragraph, TextRun, HeadingLevel } = docx;
  const pars = content.split(/\n+/).map(t => new Paragraph({
    children:[new TextRun({text:t, font:"Times New Roman", size:24})],
    spacing:{after:200}
  }));
  const doc = new Document({
    sections:[{ children:[
      new Paragraph({text:title, heading:HeadingLevel.HEADING_1, spacing:{after:400}}),
      ...pars
    ]}]
  });
  Packer.toBlob(doc).then(b => saveAs(b, filename));
}

function escapeHtml(text) {
  if(!text) return "";
  return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
}
</script>
</body>
</html>
